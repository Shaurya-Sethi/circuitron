# AGENTS.md  
*Project-specific guidelines for AI coding assistants working on **Circuitron – Agentic PCB Design Accelerator***  

---

## 1. High-Level Context
Circuitron converts natural-language design prompts into SKiDL code, KiCad schematics (`.sch`), netlists, and (optionally) auto-routed PCB layouts.  
The workflow is **agentic**: an LLM plans, reasons, retrieves documentation (RAG), writes code, runs SKiDL, and hands artefacts to engineers for review.
**Note: For a detailed overview of the project - ALWAYS reference `overview.md`**

> **Rule 0 – Never bypass expert review.**  
> All outputs are drafts and must remain **transparent, editable, and traceable**.

---

## 2. Repository Anatomy (strict – keep modules decoupled)

| Path | Purpose |
|------|---------|
| `backend/main.py` | FastAPI entrypoint (async). |
| `backend/agent/*` | Orchestrator, chain-of-thought, approval loop. |
| `backend/llm/*` | Model interface (`llm_client.py`) & **RAG** (`rag.py`). |
| `backend/kicad/*` | SKiDL / KiCad ops: `skidl_interface.py`, `part_search.py`, `pcb_tools.py`. |
| `backend/utils/*` | `config.py`, `logging.py`, `file_ops.py`. |
| `frontend/streamlit_app.py` | Prototype UI – must call backend API, never duplicate logic. |
| `tests/` | Pytest suites mirror module layout. |
| `Dockerfile` | Reproducible env incl. KiCad V5 (required for `.sch` files). |

**Do not add new top-level packages without updating this file.**

---

## 3. Coding Standards

| Aspect | Rule |
|--------|------|
| Style  | **PEP 8** + **black** (line length = 88) + **isort**. |
| Typing | Prefer **PEP 484** type hints; use `from __future__ import annotations`. |
| Docstrings | Google style; every public fn/class. |
| Logging | Use `backend.utils.logging.get_logger()` → emits JSON lines. |
| Exceptions | Raise custom error classes in `backend.utils.errors`. |
| Imports | Never import across verticals (e.g. `backend/llm` must not import from `backend/kicad`). Use dependency injection via orchestrator. |

---

## 4. Environment & Secrets

* Store API keys / paths in `.env` – **never** commit real creds.  
* `backend/utils/config.py` centralises `pydantic.BaseSettings` config.  
* Docker image must copy `.env.example` → container.

---

## 5. LangChain / RAG Directives

1. **Always retrieve SKiDL docs** before code generation (`llm.rag.get_sknippet()`).
2. Inject retrieved chunks into LLM prompt under ```SKIDL_DOCS``` delimiter.
3. Do **not** exceed ~6 k tokens in combined context (failsafe = truncate oldest docs).
4. Cite doc origin in chain-of-thought for traceability.

---

## 6. SKiDL & KiCad Rules

| Item | Directive |
|------|-----------|
| Part queries | use `search()` a built-in SKiDL function; never hardcode library names. |
| Schematic export | Use `generate_schematic()` ➜ outputs **V5 `.sch`** (limitation). Add banner: `Requires KiCad V5 Docker image`. |
| PCB export | `generate_pcb()` ➜ `.kicad_pcb`. |
| ERC | Run `ERC()` **after** instantiating parts; abort pipeline on error > 0. |
| SVG preview | Use `generate_svg()` for UI thumbnail. |

---

## 7. DeepPCB Integration

* Place auto-routing call in `pcb_tools.py::autoroute_with_deeppcb`.  
* Tag resulting file `*_autorouted.kicad_pcb`.  
* Add YAML metadata block noting “autoroute = true”.  
* Always mark autorouted designs as **DRAFT_UNVERIFIED** in API response.

---

## 8. Testing & CI

* **pytest**; run `pytest -q`.  
* Aim ≥ 90 % coverage (`pytest --cov`).  
* Lint: `black --check . && isort --check . && flake8`.  
* Add GitHub Actions workflow (`ci.yml`) running tests + lint inside Docker.

---

## 9. Common Pitfalls & Guardrails

*  **Do not** import KiCad GUI libraries (headless CI).  
*  **Do not** write to arbitrary FS paths; use `backend/utils/file_ops.get_artifact_path()`.  
*  Always validate user prompts for malicious code before `exec`.  
*  Remember KiCad V6+ **cannot** open `.sch` generated by SKiDL – provide Docker instructions in responses.

---

## 10. Quick-Start Commands

```bash
# Create and activate venv
python3 -m venv .venv && source .venv/bin/activate

# Install deps
pip install -r requirements.txt

# Run backend (hot reload)
uvicorn backend.main:app --reload

# Launch Streamlit UI (dev)
streamlit run frontend/streamlit_app.py

# Build & run full Docker stack
docker compose up --build
