flowchart TD
    subgraph CLI
        A[User] --> B[cli.main]
    end
    B --> C[TerminalUI]
    C -->|prompt| D[pipeline.run_with_retry]
    D --> E[pipeline]

    subgraph PipelineStages
        E --> P1[Planner]
        P1 --> U1[User Feedback]
        U1 --> P2[Part Finder]
        P2 --> P3[Part Selector]
        P3 --> P4[Documentation]
        P4 --> P5[Code Generation]
        P5 --> P6[Validation]
        P6 -->|loop on fail| P7[Code Correction]
        P6 --> P8[Runtime Check]
        P8 -->|loop on fail| P9[Runtime Correction]
        P8 --> P10[ERC Handling]
        P10 -->|loop on fail| P10
        P10 --> P11[Final Execution]
    end

    subgraph Tools
        T1[search_kicad_libraries]
        T2[search_kicad_footprints]
        T0[execute_calculation]
        T3[extract_pin_details]
        T4[perform_rag_query]
        T5[run_erc]
        T6[run_runtime_check]
        T7[execute_final_script]
    end

    P2 --> T1
    P2 --> T2
    P3 --> T3
    P4 --> T4
    P6 --> T4
    P6 --> getKG[get_kg_usage_guide]
    P7 --> getKG
    P8 --> T6
    P10 --> T5
    P11 --> T7

    subgraph External
        D1[MCP Server]
        D2[KiCad Docker]
        D3[Calc Docker]
    end

    T4 --> D1
    T5 --> D2
    T6 --> D2
    T7 --> D2
    T0 --> D3

    C -.->|theme switch| Theme[Theme Manager]
